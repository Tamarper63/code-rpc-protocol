{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CODE-RPC Protocol Configuration Schema",
  "type": "object",
  "required": [
    "name", "description", "instructions", "activation_trigger",
    "tier_access", "origin", "visual_identity", "tool_use",
    "preset_responses", "version", "status", "memory_policy",
    "module_boundary_policy", "design_state_tracking",
    "refactor_scope_control", "advanced_trigger_overrides"
  ],
  "properties": {
    "name": {
      "type": "string",
      "const": "CODE-RPC ‚Äì Developer Refactor Protocol"
    },
    "description": {
      "type": "string",
      "minLength": 10
    },
    "instructions": {
      "type": "object",
      "required": ["behavior"],
      "properties": {
        "behavior": {
          "type": "string",
          "pattern": "(?=.*deep search)(?=.*do not simulate)(?=.*verify yourself)(?=.*dead code)(?=.*objective deviation)(?=.*architecture)"
        }
      }
    },
    "activation_trigger": {
      "type": "string",
      "pattern": "\\[CODE-RPC/1.0\\], \\[code-check\\], \\[code-review\\]"
    },
    "tier_access": {
      "type": "string",
      "enum": ["Tier 2+", "Tier 3"]
    },
    "origin": {
      "type": "string",
      "pattern": "user/ARCH\\..+"
    },
    "visual_identity": {
      "type": "object",
      "required": ["emoji", "color", "style", "voice"],
      "properties": {
        "emoji": {
          "type": "string",
          "pattern": "üõ†Ô∏è"
        },
        "color": {
          "type": "string",
          "enum": ["dark blue"]
        },
        "style": {
          "type": "string",
          "enum": ["code-audit"]
        },
        "voice": {
          "type": "string",
          "const": "technical, terse, non-narrative"
        }
      }
    },
    "tool_use": {
      "type": "object",
      "required": ["enabled", "tools"],
      "properties": {
        "enabled": {
          "type": "boolean",
          "const": true
        },
        "tools": {
          "type": "array",
          "minItems": 6,
          "items": {
            "type": "object",
            "required": ["name", "description", "auto_invoke_in"],
            "properties": {
              "name": {
                "type": "string",
                "enum": [
                  "GitDiffAnalyzer",
                  "StructureScanner",
                  "CodeTracker",
                  "ContextTracker",
                  "DependencyResolver",
                  "TestSurfaceAnalyzer"
                ]
              },
              "description": { "type": "string" },
              "auto_invoke_in": {
                "type": "array",
                "items": {
                  "type": "string",
                  "enum": ["[CODE-RPC/1.0]", "[code-review]"]
                }
              }
            }
          }
        }
      }
    },
    "memory_policy": {
      "type": "object",
      "required": [
        "architecture_cache",
        "file_reference_tracking",
        "refactor_state_persistence"
      ],
      "properties": {
        "architecture_cache": { "type": "boolean" },
        "file_reference_tracking": { "type": "boolean" },
        "refactor_state_persistence": { "type": "boolean" }
      }
    },
    "module_boundary_policy": {
      "type": "object",
      "required": [
        "respect_layers",
        "detect_shared_libs",
        "forbid_cross_layer_refs"
      ],
      "properties": {
        "respect_layers": { "type": "boolean" },
        "detect_shared_libs": { "type": "boolean" },
        "forbid_cross_layer_refs": { "type": "boolean" }
      }
    },
    "design_state_tracking": {
      "type": "object",
      "required": [
        "enabled",
        "store_current_architecture",
        "track_shifts"
      ],
      "properties": {
        "enabled": { "type": "boolean" },
        "store_current_architecture": { "type": "boolean" },
        "track_shifts": { "type": "boolean" }
      }
    },
    "refactor_scope_control": {
      "type": "object",
      "required": [
        "max_files",
        "allow_arch_shift",
        "limit_to_module"
      ],
      "properties": {
        "max_files": { "type": "integer" },
        "allow_arch_shift": { "type": "boolean" },
        "limit_to_module": { "type": "boolean" }
      }
    },
    "advanced_trigger_overrides": {
      "type": "object",
      "patternProperties": {
        "^[a-z\\-]+$": {
          "type": "object",
          "required": ["description", "applies_to"],
          "properties": {
            "description": { "type": "string" },
            "applies_to": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["[CODE-RPC/1.0]", "[code-check]", "[code-review]"]
              }
            }
          }
        }
      },
      "additionalProperties": false
    },
    "preset_responses": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["user_input", "assistant_response"],
        "properties": {
          "user_input": { "type": "string" },
          "assistant_response": { "type": "string" }
        }
      }
    },
    "version": {
      "type": "string",
      "pattern": "1\\.4"
    },
    "status": {
      "type": "string",
      "enum": ["Public"]
    }
  }
}
